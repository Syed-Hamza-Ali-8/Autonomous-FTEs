{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ai-employee.vault/schemas/ralph-wiggum-state.json",
  "title": "Ralph Wiggum Task State",
  "description": "Schema for Ralph Wiggum autonomous task state tracking",
  "version": "1.0",
  "type": "object",
  "required": [
    "task_id",
    "task_file",
    "status",
    "iteration",
    "max_iterations",
    "started_at",
    "last_updated"
  ],
  "properties": {
    "task_id": {
      "type": "string",
      "description": "Unique task identifier",
      "pattern": "^task_[a-z0-9_]+$",
      "examples": ["task_client_proposal_20260115"]
    },
    "task_file": {
      "type": "string",
      "description": "Absolute path to task file in vault",
      "pattern": "^/.*\\.md$",
      "examples": ["/Vault/Needs_Action/task_client_proposal_20260115.md"]
    },
    "status": {
      "type": "string",
      "description": "Current task execution status",
      "enum": ["initializing", "in_progress", "waiting_approval", "completed", "failed", "timeout", "max_iterations_reached"]
    },
    "iteration": {
      "type": "integer",
      "description": "Current iteration number (1-indexed)",
      "minimum": 1,
      "examples": [1, 5, 10]
    },
    "max_iterations": {
      "type": "integer",
      "description": "Maximum allowed iterations before forced exit",
      "minimum": 1,
      "maximum": 20,
      "default": 10,
      "examples": [10]
    },
    "started_at": {
      "type": "string",
      "description": "ISO-8601 timestamp when task started",
      "format": "date-time",
      "examples": ["2026-01-15T10:00:00Z"]
    },
    "last_updated": {
      "type": "string",
      "description": "ISO-8601 timestamp of last state update",
      "format": "date-time",
      "examples": ["2026-01-15T10:15:30Z"]
    },
    "completed_at": {
      "type": "string",
      "description": "ISO-8601 timestamp when task completed (optional)",
      "format": "date-time",
      "examples": ["2026-01-15T10:30:00Z"]
    },
    "timeout_at": {
      "type": "string",
      "description": "ISO-8601 timestamp when task will timeout",
      "format": "date-time",
      "examples": ["2026-01-15T10:30:00Z"]
    },
    "timeout_minutes": {
      "type": "integer",
      "description": "Maximum execution time in minutes",
      "minimum": 1,
      "maximum": 120,
      "default": 30,
      "examples": [30]
    },
    "progress": {
      "type": "object",
      "description": "Task progress tracking",
      "required": ["steps_total", "steps_completed", "current_step"],
      "properties": {
        "steps_total": {
          "type": "integer",
          "description": "Total number of steps in task",
          "minimum": 1,
          "examples": [5]
        },
        "steps_completed": {
          "type": "integer",
          "description": "Number of completed steps",
          "minimum": 0,
          "examples": [3]
        },
        "current_step": {
          "type": "string",
          "description": "Description of current step",
          "maxLength": 200,
          "examples": ["Drafting client proposal"]
        },
        "percentage": {
          "type": "number",
          "description": "Completion percentage (0-100)",
          "minimum": 0,
          "maximum": 100,
          "examples": [60.0]
        }
      }
    },
    "iterations_history": {
      "type": "array",
      "description": "History of all iterations",
      "items": {
        "type": "object",
        "required": ["iteration", "timestamp", "action", "result"],
        "properties": {
          "iteration": {
            "type": "integer",
            "description": "Iteration number",
            "minimum": 1
          },
          "timestamp": {
            "type": "string",
            "description": "ISO-8601 timestamp",
            "format": "date-time"
          },
          "action": {
            "type": "string",
            "description": "Action taken in this iteration",
            "maxLength": 500
          },
          "result": {
            "type": "string",
            "description": "Result of action",
            "enum": ["success", "partial", "failed", "blocked"]
          },
          "error": {
            "type": "string",
            "description": "Error message if failed",
            "maxLength": 1000
          },
          "duration_seconds": {
            "type": "number",
            "description": "Duration of iteration in seconds",
            "minimum": 0
          }
        }
      }
    },
    "exit_reason": {
      "type": "string",
      "description": "Reason for task exit",
      "enum": ["completed", "max_iterations", "timeout", "error", "user_cancelled", "approval_required"],
      "examples": ["completed"]
    },
    "error": {
      "type": "object",
      "description": "Error details if task failed",
      "properties": {
        "message": {
          "type": "string",
          "description": "Error message",
          "maxLength": 1000
        },
        "type": {
          "type": "string",
          "description": "Error type",
          "enum": ["transient", "auth", "logic", "data", "system"]
        },
        "recoverable": {
          "type": "boolean",
          "description": "Whether error is recoverable"
        },
        "retry_count": {
          "type": "integer",
          "description": "Number of retry attempts",
          "minimum": 0
        }
      }
    },
    "metrics": {
      "type": "object",
      "description": "Task execution metrics",
      "properties": {
        "total_duration_seconds": {
          "type": "number",
          "description": "Total execution time in seconds",
          "minimum": 0
        },
        "api_calls": {
          "type": "integer",
          "description": "Number of API calls made",
          "minimum": 0
        },
        "files_created": {
          "type": "integer",
          "description": "Number of files created",
          "minimum": 0
        },
        "files_modified": {
          "type": "integer",
          "description": "Number of files modified",
          "minimum": 0
        },
        "actions_executed": {
          "type": "integer",
          "description": "Number of actions executed",
          "minimum": 0
        }
      }
    },
    "context": {
      "type": "object",
      "description": "Additional context for task execution",
      "properties": {
        "user": {
          "type": "string",
          "description": "User who initiated task"
        },
        "priority": {
          "type": "string",
          "description": "Task priority",
          "enum": ["low", "medium", "high", "critical"]
        },
        "tags": {
          "type": "array",
          "description": "Task tags",
          "items": {
            "type": "string"
          }
        },
        "related_tasks": {
          "type": "array",
          "description": "Related task IDs",
          "items": {
            "type": "string",
            "pattern": "^task_[a-z0-9_]+$"
          }
        }
      }
    }
  },
  "examples": [
    {
      "task_id": "task_client_proposal_20260115",
      "task_file": "/Vault/Needs_Action/task_client_proposal_20260115.md",
      "status": "completed",
      "iteration": 5,
      "max_iterations": 10,
      "started_at": "2026-01-15T10:00:00Z",
      "last_updated": "2026-01-15T10:15:30Z",
      "completed_at": "2026-01-15T10:15:30Z",
      "timeout_at": "2026-01-15T10:30:00Z",
      "timeout_minutes": 30,
      "progress": {
        "steps_total": 5,
        "steps_completed": 5,
        "current_step": "Task completed",
        "percentage": 100.0
      },
      "iterations_history": [
        {
          "iteration": 1,
          "timestamp": "2026-01-15T10:00:00Z",
          "action": "Read task requirements and gather context",
          "result": "success",
          "duration_seconds": 45.2
        },
        {
          "iteration": 2,
          "timestamp": "2026-01-15T10:03:00Z",
          "action": "Draft proposal outline",
          "result": "success",
          "duration_seconds": 120.5
        },
        {
          "iteration": 3,
          "timestamp": "2026-01-15T10:07:00Z",
          "action": "Write proposal sections",
          "result": "success",
          "duration_seconds": 180.3
        },
        {
          "iteration": 4,
          "timestamp": "2026-01-15T10:12:00Z",
          "action": "Review and refine proposal",
          "result": "success",
          "duration_seconds": 90.7
        },
        {
          "iteration": 5,
          "timestamp": "2026-01-15T10:15:00Z",
          "action": "Move task to Done folder",
          "result": "success",
          "duration_seconds": 30.1
        }
      ],
      "exit_reason": "completed",
      "metrics": {
        "total_duration_seconds": 930.0,
        "api_calls": 12,
        "files_created": 1,
        "files_modified": 3,
        "actions_executed": 5
      },
      "context": {
        "user": "hamza",
        "priority": "high",
        "tags": ["client", "proposal", "sales"],
        "related_tasks": ["task_client_followup_20260116"]
      }
    }
  ],
  "additionalProperties": false
}
